id: java.lang.security.audit.xxe.transformerfactory-dtds-not-disabled.transformerfactory-dtds-not-disabled
severity: ERROR
metadata:
  cwe:
  - 'CWE-611: Improper Restriction of XML External Entity Reference'
  owasp:
  - A04:2017 - XML External Entities (XXE)
  - A05:2021 - Security Misconfiguration
  asvs:
    section: V5 Validation, Sanitization and Encoding
    control_id: 5.5.2 Insecue XML Deserialization
    control_url: https://github.com/OWASP/ASVS/blob/master/4.0/en/0x13-V5-Validation-Sanitization-Encoding.md#v55-deserialization-prevention
    version: '4'
  references:
  - https://semgrep.dev/blog/2022/xml-security-in-java
  - https://semgrep.dev/docs/cheat-sheets/java-xxe/
  - https://blog.sonarsource.com/secure-xml-processor
  - https://xerces.apache.org/xerces2-j/features.html
  category: security
  technology:
  - java
  - xml
  cwe2022-top25: true
  cwe2021-top25: true
  subcategory:
  - vuln
  likelihood: LOW
  impact: HIGH
  confidence: HIGH
  license: Commons Clause License Condition v1.0[LGPL-2.1-only]
  vulnerability_class:
  - XML Injection
  source: https://semgrep.dev/r/java.lang.security.audit.xxe.transformerfactory-dtds-not-disabled.transformerfactory-dtds-not-disabled
  shortlink: https://sg.run/1wyQ
  semgrep.dev:
    rule:
      r_id: 59622
      rv_id: 109756
      rule_id: v8UeQ1
      version_id: kbTdxNZ
      url: https://semgrep.dev/playground/r/kbTdxNZ/java.lang.security.audit.xxe.transformerfactory-dtds-not-disabled.transformerfactory-dtds-not-disabled
      origin: community
message: DOCTYPE declarations are enabled for this TransformerFactory. This is vulnerable
  to XML external entity attacks. Disable this by setting the attributes "accessExternalDTD"
  and "accessExternalStylesheet" to "".
mode: taint
pattern-sources:
- by-side-effect: true
  patterns:
  - pattern-either:
    - pattern: '$FACTORY = TransformerFactory.newInstance();

        '
    - patterns:
      - pattern: $FACTORY
      - pattern-inside: "class $C {\n  ...\n  $V $FACTORY = TransformerFactory.newInstance();\n\
          \  ...\n}\n"
      - pattern-not-inside: "class $C {\n  ...\n  $V $FACTORY = TransformerFactory.newInstance();\n\
          \  static {\n    ...\n    $FACTORY.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD,\
          \ \"\");\n    ...\n    $FACTORY.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET,\
          \ \"\");\n    ...\n  }\n  ...\n}\n"
      - pattern-not-inside: "class $C {\n  ...\n  $V $FACTORY = TransformerFactory.newInstance();\n\
          \  static {\n    ...\n    $FACTORY.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET,\
          \ \"\");\n    ...\n    $FACTORY.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD,\
          \ \"\");\n    ...\n  }\n  ...\n}\n"
      - pattern-not-inside: "class $C {\n  ...\n  $V $FACTORY = TransformerFactory.newInstance();\n\
          \  static {\n    ...\n    $FACTORY.setAttribute(\"=~/.*accessExternalDTD.*/\"\
          , \"\");\n    ...\n    $FACTORY.setAttribute(\"=~/.*accessExternalStylesheet.*/\"\
          , \"\");\n    ...\n  }\n  ...\n}\n"
      - pattern-not-inside: "class $C {\n  ...\n  $V $FACTORY = TransformerFactory.newInstance();\n\
          \  static {\n    ...\n    $FACTORY.setAttribute(\"=~/.*accessExternalStylesheet.*/\"\
          , \"\");\n    ...\n    $FACTORY.setAttribute(\"=~/.*accessExternalDTD.*/\"\
          , \"\");\n    ...\n  }\n  ...\n}\n"
pattern-sinks:
- patterns:
  - pattern: $FACTORY.newTransformer(...);
pattern-sanitizers:
- by-side-effect: true
  pattern-either:
  - patterns:
    - pattern-either:
      - pattern: '$FACTORY.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET, "");
          ...

          $FACTORY.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, "");

          '
      - pattern: '$FACTORY.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, "");

          ...

          $FACTORY.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET, "");

          '
      - pattern: '$FACTORY.setAttribute("=~/.*accessExternalStylesheet.*/", ""); ...

          $FACTORY.setAttribute("=~/.*accessExternalDTD.*/", "");

          '
      - pattern: '$FACTORY.setAttribute("=~/.*accessExternalDTD.*/", "");

          ...

          $FACTORY.setAttribute("=~/.*accessExternalStylesheet.*/", "");

          '
    - focus-metavariable: $FACTORY
  - patterns:
    - pattern-either:
      - pattern-inside: "class $C {\n  ...\n  $T $M(...) {\n    ...\n    $FACTORY.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET,\
          \ \"\");\n    ...\n    $FACTORY.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD,\
          \ \"\");\n    ...\n  }\n  ...\n}\n"
      - pattern-inside: "class $C {\n  ...\n  $T $M(...) {\n    ...\n    $FACTORY.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD,\
          \ \"\");\n    ...\n    $FACTORY.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET,\
          \ \"\");\n    ...\n  }\n  ...\n}\n"
      - pattern-inside: "class $C {\n  ...\n  $T $M(...) {\n    ...\n    $FACTORY.setAttribute(\"\
          =~/.*accessExternalStylesheet.*/\", \"\");\n    ...\n    $FACTORY.setAttribute(\"\
          =~/.*accessExternalDTD.*/\", \"\");\n    ...\n  }\n  ...\n}\n"
      - pattern-inside: "class $C {\n  ...\n  $T $M(...) {\n    ...\n    $FACTORY.setAttribute(\"\
          =~/.*accessExternalDTD.*/\", \"\");\n    ...\n    $FACTORY.setAttribute(\"\
          =~/.*accessExternalStylesheet.*/\", \"\");\n    ...\n  }\n  ...\n}\n"
    - pattern: $M($X)
    - focus-metavariable: $X
fix: '$FACTORY.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, ""); $FACTORY.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET,
  "");

  $FACTORY.newTransformer(...);

  '
languages:
- java
